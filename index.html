<!DOCTYPE html>
<html>
<head>
  <title>Remote Sensor Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    #loading {
      text-align: center;
      margin: 20px;
    }
    #error {
      color: red;
      margin: 20px;
    }
    canvas {
      max-height: 600px;
    }
  </style>
</head>
<body>
  <h2>Remote Sensor Data from Google Sheets</h2>
  <div id="loading">Loading data...</div>
  <div id="error"></div>
  <canvas id="chart" height="400"></canvas>

  <script>
    const chartCtx = document.getElementById('chart').getContext('2d');
    const sensorChart = new Chart(chartCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { 
            label: 'Temperature (°C)', 
            data: [], 
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.1,
            fill: false,
            yAxisID: 'y' 
          },
          { 
            label: 'Humidity (%)', 
            data: [], 
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            tension: 0.1,
            fill: false,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        scales: {
          x: {
            ticks: {
              autoSkip: true,
              maxTicksLimit: 20
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'Temperature (°C)'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'Humidity (%)'
            },
            grid: {
              drawOnChartArea: false,
            }
          }
        }
      }
    });

    async function fetchData() {
      try {
        const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS6P6hzIdOoBMMRfgCgFF7gQ9DWvhlsmXz2hxHx3mmJuYIlanN8QjWWYT1V34UXd9PJC-2qWbTiBriZ/pub?gid=0&single=true&output=csv';
        
        // Add timestamp to URL to prevent caching
        const timestamp = new Date().getTime();
        const response = await fetch(`${url}&t=${timestamp}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const dataText = await response.text();
        const rows = dataText.split('\n').filter(row => row.trim() !== ''); // remove empty rows
        
        if (rows.length <= 1) {
          throw new Error('No data rows found in the sheet');
        }
        
        // Skip header row
        const dataRows = rows.slice(1); 
        
        const times = [];
        const temps = [];
        const hums = [];

        dataRows.forEach(row => {
          // Proper CSV parsing that handles quoted fields
          const cols = parseCSVRow(row);
          
          if (cols.length >= 4) {
            try {
              const dateStr = cols[0].trim();
              const timeStr = cols[1].trim();
              const temp = parseFloat(cols[2].trim());
              const hum = parseFloat(cols[3].trim());
              
              if (!isNaN(temp) && !isNaN(hum)) {
                // Combine date and time for display
                times.push(`${dateStr} ${timeStr}`);
                temps.push(temp);
                hums.push(hum);
              }
            } catch (e) {
              console.error('Error parsing row:', row, e);
            }
          }
        });

        if (times.length > 0) {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('error').textContent = '';
          
          sensorChart.data.labels = times;
          sensorChart.data.datasets[0].data = temps;
          sensorChart.data.datasets[1].data = hums;
          sensorChart.update();
        } else {
          document.getElementById('error').textContent = 'No valid data found in the sheet.';
        }
      } catch (error) {
        console.error('Error fetching data:', error);
        document.getElementById('error').textContent = `Error loading data: ${error.message}`;
        document.getElementById('loading').style.display = 'none';
      }
    }

    // Helper function to properly parse CSV rows that might contain commas in fields
    function parseCSVRow(row) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < row.length; i++) {
        const char = row[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current);
      return result;
    }

    // Initial load
    fetchData();
    
    // Refresh every 30 seconds
    setInterval(fetchData, 30000);
  </script>
</body>
</html>